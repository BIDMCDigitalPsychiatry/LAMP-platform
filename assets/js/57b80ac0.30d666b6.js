"use strict";(self.webpackChunklamp_platform=self.webpackChunklamp_platform||[]).push([[1637],{23146:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/push_notifications-d682e6f910e5410f132684088ec959e0.png"},28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>r});var t=i(96540);const o={},s=t.createContext(o);function a(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(s.Provider,{value:n},e.children)}},58962:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"develop/app_gateway","title":"App Gateway","description":"This documentation is for BIDMC Digital Psychiatry internal use only.","source":"@site/docs/08-develop/07-app_gateway.md","sourceDirName":"08-develop","slug":"/develop/app_gateway","permalink":"/develop/app_gateway","draft":false,"unlisted":false,"editUrl":"https://github.com/BIDMCDigitalPsychiatry/LAMP-platform/edit/master/docs/08-develop/07-app_gateway.md","tags":[],"version":"current","lastUpdatedBy":"Juan","lastUpdatedAt":1740768074000,"sidebarPosition":7,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Just-In-Time Adaptive Interventions","permalink":"/develop/adaptive_interventions"},"next":{"title":"Scheduling Tasks with Cron Jobs in LAMP","permalink":"/develop/cron_jobs"}}');var o=i(74848),s=i(28453);const a={},r="App Gateway",l={},d=[{value:"Introduction",id:"introduction",level:3},{value:"Notification Flow",id:"notification-flow",level:3},{value:"Supported Features",id:"supported-features",level:3},{value:"Generating API Keys",id:"generating-api-keys",level:3},{value:"API Usage",id:"api-usage",level:3},{value:"Internal Flow",id:"internal-flow",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h3:"h3",header:"header",img:"img",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"app-gateway",children:"App Gateway"})}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsx)(n.p,{children:"This documentation is for BIDMC Digital Psychiatry internal use only."})}),"\n",(0,o.jsx)(n.h3,{id:"introduction",children:"Introduction"}),"\n",(0,o.jsx)(n.p,{children:"The mindLAMP apps for both iOS and Android enable two additional features beyond what is offered by simply logging into the dashboard and bookmarking the tab on the user's mobile device:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"sensor data collection, and"}),"\n",(0,o.jsx)(n.li,{children:"push notification scheduling for Activities."}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["However, sending a push notification from a LAMP server to a mobile device requires encrypted communication with official Apple and Google gateway servers (called ",(0,o.jsx)(n.a,{href:"https://developer.apple.com/documentation/usernotifications/sending_push_notifications_using_command-line_tools",children:"Apple Push Notification Service, or APNS"}),", and ",(0,o.jsx)(n.a,{href:"https://firebase.google.com/docs/cloud-messaging/send-message",children:"Google Firebase Cloud Messaging, or FCM"}),"). These gateways are only authorized to receive push notification requests from servers with an approved developer certificate (a file with the extention ",(0,o.jsx)(n.code,{children:".p8"})," or ",(0,o.jsx)(n.code,{children:".p12"}),") and developers must be granted access to this feature."]}),"\n",(0,o.jsxs)(n.p,{children:["Apple and Google both require BIDMC Digital Psychiatry to maintain records of approved IRB documents or clinical protocols (if not a research study) to allow external collaborators' LAMP servers to communicate with the native iOS and Android apps. This is because both apps are published under ",(0,o.jsx)(n.code,{children:"John Torous"}),"'s developer accounts."]}),"\n",(0,o.jsx)(n.h3,{id:"notification-flow",children:"Notification Flow"}),"\n",(0,o.jsxs)(n.p,{children:["As a result, the LAMP Platform includes an ",(0,o.jsx)(n.strong,{children:"App Gateway"})," component (located at ",(0,o.jsx)(n.code,{children:"app-gateway.lamp.digital"}),") that acts as an intermediary:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"A patient logs in to the mindLAMP iOS app on a collaborator's LAMP server."}),"\n",(0,o.jsx)(n.li,{children:"The collaborator's LAMP server schedules push notifications to be sent to the new iOS device registered."}),"\n",(0,o.jsxs)(n.li,{children:["At time of notification, the collaborator's LAMP server sends the notification to the ",(0,o.jsx)(n.strong,{children:"App Gateway"})," hosted by BIDMC."]}),"\n",(0,o.jsxs)(n.li,{children:["This notification request contains the collaborator's ",(0,o.jsx)(n.strong,{children:"unique API Key"}),". These API Keys should ",(0,o.jsx)(n.strong,{children:"NEVER"})," be shared with others."]}),"\n",(0,o.jsxs)(n.li,{children:["The ",(0,o.jsx)(n.strong,{children:"App Gateway"})," verifies the included notification's API Key ",(0,o.jsx)(n.strong,{children:"but does NOT have access to the notification contents, to ensure privacy."})]}),"\n",(0,o.jsxs)(n.li,{children:["If the API Key is valid, the ",(0,o.jsx)(n.strong,{children:"App Gateway"})," forwards the notification request to either Apple or Google servers automatically."]}),"\n",(0,o.jsx)(n.li,{children:"If the API Key is NOT valid, an error message is returned to the collaborator's LAMP server."}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"supported-features",children:"Supported Features"}),"\n",(0,o.jsxs)(n.p,{children:["This ",(0,o.jsx)(n.strong,{children:"App Gateway"})," component ",(0,o.jsx)(n.strong,{children:"MUST NOT"})," be self-hosted by external collaborators, unless they also intend to self-publish the iOS and Android apps as well (which is highly discouraged). The ",(0,o.jsx)(n.strong,{children:"App Gateway"})," supports multiple destinations, and each has a unique ",(0,o.jsx)(n.code,{children:"device_token"})," prefix:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Apple Push Notification Service (iOS/macOS devices; ",(0,o.jsx)(n.code,{children:"apns:<device_token>"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["Google Firebase Cloud Messaging (Android devices; ",(0,o.jsx)(n.code,{children:"gcm:<device_token>"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["Amazon Web Services Simple Email Service (Email; ",(0,o.jsx)(n.code,{children:"mailto:<email_address>"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["Amazon Web Services Simple Notification Service (SMS; ",(0,o.jsx)(n.code,{children:"sms:<phone_number>"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["Slack Webhooks (Slack channels; ",(0,o.jsx)(n.code,{children:"slack:<webhook_id>"}),")"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["External collaborators are ",(0,o.jsx)(n.strong,{children:"NOT PERMITTED"})," to use ",(0,o.jsx)(n.code,{children:"mailto:"}),", ",(0,o.jsx)(n.code,{children:"sms:"}),", or ",(0,o.jsx)(n.code,{children:"slack:"})," destinations. ",(0,o.jsxs)(n.a,{href:"https://docs.lamp.digital/develop/app_gateway",children:["More information on ",(0,o.jsx)(n.strong,{children:"sending messages through the App Gateway from the command line"})," can be found here."]})]}),"\n",(0,o.jsx)(n.h3,{id:"generating-api-keys",children:"Generating API Keys"}),"\n",(0,o.jsx)(n.p,{children:"To allow external collaborators to send push notifications to users' iOS and Android devices, the following steps must be completed:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"collaborator organization must complete the consortium enrollment form"}),"\n",(0,o.jsxs)(n.li,{children:["collaborator organization must make the request for an API Key ",(0,o.jsx)(n.strong,{children:"on the community forum"})," (emailed requests ",(0,o.jsx)(n.strong,{children:"ARE NOT PERMITTED"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["a BIDMC team member must save this information to the ",(0,o.jsx)(n.code,{children:"Projects \u2192 LAMP Platform \u2192 Documents \u2192 People Pipeline \u2192 Consortium Members"})," database in the internal team Notion."]}),"\n",(0,o.jsxs)(n.li,{children:["the BIDMC team member must generate a new API Key in the terminal using this command: ",(0,o.jsx)(n.code,{children:"openssl rand -base64 12"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"An API Key is actually just a randomly generated string to uniquely identify an external collaborator, and contains no other information."}),"\n",(0,o.jsxs)(n.li,{children:["Should an API Key need to be replaced, a new one can be generated and replaced in this database (but all previously generated keys must be recorded in the ",(0,o.jsx)(n.code,{children:"Notes"})," field)."]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["the BIDMC team member must add this API Key to the App Gateway service in the internal Docker console (located at ",(0,o.jsx)(n.code,{children:"console.lamp.digital"}),").","\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Once logged in, locate ",(0,o.jsx)(n.code,{children:"mindLAMP \u2192 Stacks \u2192 LAMP \u2192 Editor (tab)"})," and scroll down to find ",(0,o.jsx)(n.code,{children:"app-gateway"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Edit this YAML configuration under ",(0,o.jsx)(n.code,{children:"environment \u2192 API_KEYS"}),": add the new API Key at the end of this list, separated by a comma. (",(0,o.jsx)(n.strong,{children:"DO NOT"})," include a trailing comma.)"]}),"\n",(0,o.jsxs)(n.li,{children:["Press the ",(0,o.jsx)(n.code,{children:"Update the Stack"})," button."]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["the BIDMC team member should respond to the collaborator organization ",(0,o.jsx)(n.strong,{children:"via private DM on the forum"})," with this new API Key."]}),"\n",(0,o.jsxs)(n.li,{children:["the collaborator organization fills in the API Key in their LAMP Platform configuration (",(0,o.jsx)(n.a,{href:"https://docs.lamp.digital/deploy/deploying",children:"see here"})," for more info)"]}),"\n"]}),"\n",(0,o.jsxs)(n.admonition,{type:"info",children:[(0,o.jsx)(n.mdxAdmonitionTitle,{}),(0,o.jsx)(n.p,{children:"Should an API Key be revoked, follow the above procedures to remove the API Key from the Docker console and notify the external collaborator organization."})]}),"\n",(0,o.jsx)(n.h3,{id:"api-usage",children:"API Usage"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.a,{href:"/data_science/cortex/utils/notifications",children:"utility functions provided by Cortex should be preferred"})," over making raw API calls to the App Gateway. However, an example of the raw API call using ",(0,o.jsx)(n.code,{children:"cURL"})," is provided below."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'curl -XPOST "https://app-gateway.lamp.digital/push" \\\n -H \'Content-Type: application/json\' \\\n --data-binary @- <<\'EOF\'\n{\n   "api_key": "YOUR_API_TOKEN_HERE",\n   "device_token": "apns:YOUR_APNS_DEVICE_TOKEN_HERE",\n   "payload": {\n      "aps": {\n         "alert": "Hello world!",\n         "badge": 0,\n         "sound": "default",\n         "mutable-content": 1,\n         "content-available": 1\n      },\n      "notificationId": "test123",\n      "expiry": 84600000,\n      "actions": []\n   }\n}\nEOF\n'})}),"\n",(0,o.jsx)(n.h3,{id:"internal-flow",children:"Internal Flow"}),"\n",(0,o.jsxs)(n.p,{children:["The flow of data is shown below:\n",(0,o.jsx)(n.img,{src:i(23146).A+"",width:"2200",height:"1874"})]}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"Automations Worker"})," component handles all push notification scheduling working in tandem with the API Server using the ",(0,o.jsx)(n.code,{children:"LAMP-js"})," SDK. It caches CRON expressions matching to Activity IDs and Participant IDs for delivery. The workflow is shown below:"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:i(64300).A+"",width:"913",height:"738"})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},64300:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/activity_schedules-aa8c83e11230f46bad8e8ee0f3ce7696.svg"}}]);